<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      Retrieve Music on Hold files from CUCM and stream from router flash &middot; Mark Holloway
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="http://localhost:4000/public/css/poole_custom.css">
  <link rel="stylesheet" href="/public/css/syntax_dracula.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/hyde_custom.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface|Press+Start+2P|Exo+2:700">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="http://localhost:4000/public/favicon.ico">



  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- Force https -->
  
  <script>
    var host = 'markholloway.github.io';
    if (window.location.host == host && window.location.protocol != 'https:') {
        window.location.protocol = 'https:';
    }
</script>

  

  <!-- Jekyll SEO tag plugin -->
  <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Retrieve Music on Hold files from CUCM and stream from router flash | Mark Holloway</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Retrieve Music on Hold files from CUCM and stream from router flash" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is a brief explanation of how to retrieve the MoH or Music on Hold files from Cisco Unified Communications Manager 7 and load the files into a router’s flash for remote-site streaming directly from the router." />
<meta property="og:description" content="This is a brief explanation of how to retrieve the MoH or Music on Hold files from Cisco Unified Communications Manager 7 and load the files into a router’s flash for remote-site streaming directly from the router." />
<link rel="canonical" href="http://localhost:4000/2010/08/29/retrieve-moh-cisco/" />
<meta property="og:url" content="http://localhost:4000/2010/08/29/retrieve-moh-cisco/" />
<meta property="og:site_name" content="Mark Holloway" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2010-08-29T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@twilion2" />
<script type="application/ld+json">
{"description":"This is a brief explanation of how to retrieve the MoH or Music on Hold files from Cisco Unified Communications Manager 7 and load the files into a router’s flash for remote-site streaming directly from the router.","@type":"BlogPosting","url":"http://localhost:4000/2010/08/29/retrieve-moh-cisco/","headline":"Retrieve Music on Hold files from CUCM and stream from router flash","dateModified":"2010-08-29T00:00:00-04:00","datePublished":"2010-08-29T00:00:00-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2010/08/29/retrieve-moh-cisco/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

  
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-131536379-1', 'auto');
  ga('send', 'pageview');

</script>



  <body>
    
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Mark Holloway
        </a>
      </h1>
      <p class="lead">Turning Telco into Code</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
      
        
          
            <a class="sidebar-nav-item" href="/archive/">Archive</a>
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <p>
        <a class="sidebar-nav-icons" href="https://github.com/markholloway" target="blank"><img src="/public/GitHub-Mark-Light-32px.png" alt="Github" width="18" height="18"></a>
        <a class="sidebar-nav-icons" href="http://www.linkedin.com/in/mholloway/" target="blank"><img src="/public/linkedin.png" alt="LinkedIn" width="19" height="19"></a>
      </p>

    </nav>

    <p><small>&copy; 2019 All rights reserved.</small></p>
  </div>
</div>


    <div class="content container">
      



<div class="post">
  <h1 class="post-title">Retrieve Music on Hold files from CUCM and stream from router flash</h1>
  <span class="post-date">29 Aug 2010 <i class="fa fa-tag"></i> <a href="/blog/tag/cisco/">#cisco</a> </span>

  <p>This is a brief explanation of how to retrieve the <code class="highlighter-rouge">MoH</code> or Music on Hold files from Cisco Unified Communications Manager 7 and load the files into a router’s flash for remote-site streaming directly from the router.<br />
<!--more--></p>

<p>Alternatively, if you have <code class="highlighter-rouge">CME</code> or Call Manage Express and do not care about using a <code class="highlighter-rouge">G729</code> audio file then you may use music-on-hold.au file which makes this entire task much simpler. The only difference between audio files from UCM versus CME is the actual music that is played.  UCM plays a style of music that is along the lines of the New Age genre and CME uses a song where a piano is the main instrument.</p>

<h2 id="part-1">Part 1:</h2>

<p>In order to complete this process you must have <code class="highlighter-rouge">SFTP</code> or Secure FTP server available on your network and reachable by the UCM Publisher or Subscriber.  If you don’t already have an SFTP server on your network you can use CentOS, FreeBSD, RHEL, Mac OS X, or any Unix-based platform where SFTP is natively part of the OS.</p>

<p>The same principle applies whether you want the <code class="highlighter-rouge">G711</code> or <code class="highlighter-rouge">G729</code> file.  In this example I show how to retrieve the G729 file.</p>

<p>Perform the following steps.</p>

<ol>
  <li>SSH to the UCM Publisher or Subscriber node.</li>
  <li>Enter the following command file list activelog mohprep/* and note the list of files displayed.</li>
  <li>In this case we want to SFTP the file SampleAudioSource.g729.wav to our SFTP server</li>
  <li>Enter the following command file get activelog mohprep/SampleAudioSource.g729.wav</li>
  <li>The following information will be displayed. Enter the appropriate SFTP information when prompted.</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Please wait while the system is gathering files info …done.
Sub-directories were not traversed.
Number of files affected: 1
Total size in Bytes: 2702728
Total size in Kbytes: 2639.3828
Would you like to proceed [y/n]? y

SFTP server IP: 177.1.10.2
SFTP server port [22]:
User ID: mark
Password: *********

.
Transfer completed.

</code></pre></div></div>

<p>At this point the file SampleAudioSource.g729.wav now resides on the SFTP server.  Copy this file to a TFTP server and issue the command copy tftp flash on the router the file should reside on.  In my case the same Linux server used for SFTP is also a TFTP server.  Any Unix-like OS is capable of supporting SFTP and TFTP.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>router# copy tftp flash
Address or name of remote host []? 177.1.10.2
Source filename []? SampleAudioSource.g729.wav
Destination filename [SampleAudioSource.g729.wav]?
Accessing tftp://177.1.10.2/SampleAudioSource.g729.wav…
Loading SampleAudioSource.g729.wav from 177.1.10.2 (via Serial0/3/0.1): !!
[OK - 332600 bytes]

332600 bytes copied in 51.848 secs (6415 bytes/sec)

</code></pre></div></div>

<h2 id="part-2">Part 2:</h2>

<p>In the event the branch router should stream MoH directly from the router’s flash rather than utilize the WAN to support unicast or multicast MoH between UCM and the branch site, you must configure SRST and the relevant multicast and moh parameters on the router.  It is important to note that in order to accomplish this there must be a MoH Server configured on UCM to support multicast.  This server should have a Max Hop of 1 and be assigned to a Media Resource Group (such as MRG_BR1) which should be assigned to a Media Resource Group List (MRGL_BR1) and the MRGL should be assigned to the Device Pool for BR1 (DP_BR1). Make sure the MoH server in UCM uses 239.1.1.1 in order to match the example router configuration below.  Increment multicast by IP rather than port.</p>

<p>On the router:</p>

<p>Voice VLAN Interface IP = 172.16.1.1
Loopback 0 Interface IP= 172.16.254.254</p>

<p>Enter config mode on the router and enable multicast routing</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
ip multicast-routing
interface vlan 4 &lt; Voice VLAN
ip pim dense-mode
interface loopback0
ip pim dense-mode

Enable call-manager-fallback or use telephony-service in SRST mode

call-manager-fallback
max-ephones 1
max-dn 1
ip source-address &lt;voice vlan&gt;
moh music-on-hold.au
multicast moh 239.1.1.1 port 16384 route 172.16.1.1 172.16.254.254

ccm-manager music-on-hold bind loopback 0

</code></pre></div></div>

<p>UCM believes the multicast stream only requires one hop to reach the destination.  Since this is not possible because the branch router is more than one hop from UCM, the audio file referenced in Flash by SRST will begin a multicast stream.  When phones put a call on hold the music streamed from Flash is what the held party will hear (including PSTN callers). For sites with low bandwidth requirements this helps reduce overall bandwidth consumption.  It also provides flexibility for the branch site to use their own custom audio files without the extra work of importing them into UCM.</p>

<p>If the branch router is configured as an H323 Gateway with CUCM then perform the following additional steps and add relevant dial-peers that include G711.  This is required if the MoH stream in CUCM in configured for G711 and the router thinks in needs to stream multicast G711 MoH from CUCM even though we are doing it from flash because we have invoked it through SRST.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
voice class codec 1
codec preference 1 g711ulaw
codec preference 2 g729r8

dial-peer voice 10 voip
description TO UCM SUBSCRIBER NODE
preference 1
destination-pattern 2…$
voice-class codec 1
session target ipv4:10.10.10.1
dtmf-relay h245-alphanumeric
no vad

dial-peer voice 11 voip
description TO UCM PUBLISHER NODE
preference 2
destination-pattern 2…$
voice-class codec 1
session target ipv4:10.10.10.2
dtmf-relay h245-alphanumeric
no vad

</code></pre></div></div>

<p>Issue the following debug command to validate the MoH multicast stream:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debug ephone moh
</code></pre></div></div>


</div>

<!--
<div class="donate">
</div>

-->



<!-- fluidvids.js -->
<script src="/public/js/fluidvids/dist/fluidvids.js"></script>
<script>
fluidvids.init({
  selector: ['iframe'],
  players: ['www.youtube.com', 'player.vimeo.com']
});
</script>



  <!-- Disqus comments. -->
<div id="disqus_thread"></div>
<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables

var disqus_config = function () {
this.page.url = 'http://localhost:4000/2010/08/29/retrieve-moh-cisco/'; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = '/2010/08/29/retrieve-moh-cisco/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/

/**

Using variables from _config.yml instead of static entries

*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//mh-blog-2.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



    </div>

  </body>
</html>
