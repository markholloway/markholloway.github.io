<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
    <title>Building Python wheels targeting different interpreter versions | Mark Holloway</title>
    <meta name="description" content="Notes from a curiosity-driven engineer.">
    <link rel="canonical" href="http://localhost:1313/blog/2023/06/02/building-python-wheels-targeting-different-interpreter-versions/">
    
    
    <meta property="og:url" content="http://localhost:1313/blog/2023/06/02/building-python-wheels-targeting-different-interpreter-versions/">
  <meta property="og:site_name" content="Mark Holloway">
  <meta property="og:title" content="Building Python wheels targeting different interpreter versions">
  <meta property="og:description" content="This is a short post on how you can publish wheels onto PyPi, using hatchlingâ€™s custom metadata hook, that seamlessly targets different Python interpreter versions.
Letâ€™s say you want to distribute some generated contents, which is intended to be consumed by the same Python interpreter version which generated the contents. This could be solved in a few different ways, but here Iâ€™ve opted to use a matrix of Python versions in CI. For each Python version, I generate the desired content and then I build the wheel, using some custom hatchling hooks. The end result is a wheel (per Python version) that can only be installed by that same Python version.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2023-06-02T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-06-02T00:00:00+00:00">
    <meta property="article:tag" content="Python">

    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Building Python wheels targeting different interpreter versions">
  <meta name="twitter:description" content="This is a short post on how you can publish wheels onto PyPi, using hatchlingâ€™s custom metadata hook, that seamlessly targets different Python interpreter versions.
Letâ€™s say you want to distribute some generated contents, which is intended to be consumed by the same Python interpreter version which generated the contents. This could be solved in a few different ways, but here Iâ€™ve opted to use a matrix of Python versions in CI. For each Python version, I generate the desired content and then I build the wheel, using some custom hatchling hooks. The end result is a wheel (per Python version) that can only be installed by that same Python version.">

    
    
    
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Building Python wheels targeting different interpreter versions",
  "datePublished": "2023-06-02T00:00:00Z",
  "dateModified": "2023-06-02T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http:\/\/localhost:1313\/blog\/2023\/06\/02\/building-python-wheels-targeting-different-interpreter-versions\/"
  },
  "author": {
    "@type": "Person",
    "name": "map[]"
  },
  "description": "This is a short post on how you can publish wheels onto PyPi, using hatchling\u0026rsquo;s custom metadata hook, that seamlessly targets different Python interpreter versions.\nLet\u0026rsquo;s say you want to distribute some generated contents, which is intended to be consumed by the same Python interpreter version which generated the contents. This could be solved in a few different ways, but here I\u0026rsquo;ve opted to use a matrix of Python versions in CI. For each Python version, I generate the desired content and then I build the wheel, using some custom hatchling hooks. The end result is a wheel (per Python version) that can only be installed by that same Python version.\n"
}
</script>



    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    
    
    <link rel="preload" href="/fonts/BerkeleyMono-Variable.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/CommitMono-Variable.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/MapleMono-Italic.woff2" as="font" type="font/woff2" crossorigin>
    
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/github-link.css" />
    
    <script defer src="https://cloud.umami.is/script.js" data-website-id="c9c97df3-bc05-4b29-8caa-fcf03a05710f"></script>

  </head>

  <body class="preload">
    <script>
      (function() {
        
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
          document.body.classList.add(savedTheme);
        } else {
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark');
          }
        }
        
        
        if ('fonts' in document) {
          
          Promise.race([
            document.fonts.ready,
            new Promise(resolve => setTimeout(resolve, 100)) 
          ]).then(() => {
            document.body.classList.remove('preload');
          });
        } else {
          
          setTimeout(() => {
            document.body.classList.remove('preload');
          }, 50);
        }
      })();
    </script>

    <nav style="display: flex; align-items: center; gap: 1em; flex-wrap: wrap;">
      <ul class="menu" style="margin: 0; padding: 0; flex-shrink: 0;">
        
        
        <li><a  href="/">Home</a></li>
        
        <li><a  href="/blog/">Blog</a></li>
        
        <li><a  href="/about/">About</a></li>
        
        <li><button id="theme-toggle" style="background:none; border:none; cursor:pointer; font-size:1em; padding:5px; color:inherit;">â—‘</button></li>
      </ul>
      
      
      <div id="search" style="flex-grow: 1; min-width: 200px;"></div>
    </nav>
    
    <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/pagefind/pagefind-ui.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            new PagefindUI({ 
              element: "#search", 
              showSubResults: true,
              showImages: false,
              translations: {
                placeholder: "Search...",
                clear_search: "Ã—"
              }
            });

            
            document.addEventListener('click', (e) => {
                const searchContainer = document.querySelector('#search');
                if (searchContainer && !searchContainer.contains(e.target)) {
                    const clearButton = searchContainer.querySelector('.pagefind-ui__search-clear');
                    if (clearButton) {
                        clearButton.click();
                    }
                }
            });

            
            const toggle = document.getElementById('theme-toggle');
            const body = document.body;

            toggle.addEventListener('click', () => {
              if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                body.classList.add('light');
                localStorage.setItem('theme', 'light');
              } else {
                body.classList.remove('light');
                body.classList.add('dark');
                localStorage.setItem('theme', 'dark');
              }
            });
        });
    </script>


<div class="article-meta">
<h1><span class="title">Building Python wheels targeting different interpreter versions</span></h1>

<div class="article-meta-info">
  <span class="date">2023-06-02</span>
  
  <span class="article-tags">
    
    
    
    <a href="/tags/python">#python</a>
    
    
  </span>
  
</div>
</div>



<main data-pagefind-body>
	
	
		
		<aside class="table-of-contents">
			<div class="toc-title">
				<svg class="callout-icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"
					fill="currentColor">
					<path
						d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h14v-2H3v2zm16 0h2v-2h-2v2zm0-10v2h2V7h-2zm0 6h2v-2h-2v2z">
					</path>
				</svg>
				Table of Contents
			</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#constraining-the-required-python-version-and-naming-the-wheel">Constraining the required Python version and naming the wheel</a>
      <ul>
        <li><a href="#create-a-metadata-hook">Create a metadata hook</a></li>
        <li><a href="#create-a-build-hook">Create a build hook</a></li>
        <li><a href="#edit-pyprojecttoml">Edit <code>pyproject.toml</code></a></li>
        <li><a href="#build-the-wheel">Build the wheel</a></li>
        <li><a href="#tying-it-all-together">Tying it all together</a></li>
      </ul>
    </li>
  </ul>
</nav>
		</aside>
		

		<p>This is a short post on how you can publish wheels onto 



<a href="https://pypi.org" target="_blank" rel="noopener">PyPi</a>, using 



<a href="https://hatch.pypa.io/latest/" target="_blank" rel="noopener">hatchling&rsquo;s</a> custom metadata hook, that seamlessly targets different Python interpreter versions.</p>
<p>Let&rsquo;s say you want to distribute some generated contents, which is intended to be consumed by the same Python interpreter version which generated the contents. This could be solved in a few different ways, but here I&rsquo;ve opted to use a matrix of Python versions in CI. For each Python version, I generate the desired content and then I build the wheel, using some custom hatchling hooks. The end result is a wheel (per Python version) that can only be installed by that same Python version.</p>
<p>I can then publish them all onto PyPi under the same project name and project version. When running <code>pip install ...</code>, pip would then pick the wheel that was built and intended for the Python interpreter version I&rsquo;m using, guaranteeing that the version generated the wheel contents will be used to also consume the contents.</p>
<h2 id="constraining-the-required-python-version-and-naming-the-wheel">Constraining the required Python version and naming the wheel</h2>
<p>In <code>pyproject.toml</code>, you can specify metadata such as for example the version string. Hatchling offers the ability to write custom hooks so to edit this metadata when e.g. building the wheel. Hatchling also provides hooks to explain <em>how</em> the wheel should be built, so called build hooks. What we want to do here is edit the <code>requires</code> metadata to only the Python version(s) we want to allow (using a metadata hook) and then name the wheels accordingly (using a build hook).</p>
<h3 id="create-a-metadata-hook">Create a metadata hook</h3>
<p>Let&rsquo;s start with editing the metadata of the wheel, so we can constrain the required Python version. Let&rsquo;s add <code>custom_metadata_hook.py</code>:</p>
<blockquote class="callout markdown-alert callout-note markdown-alert-note"><div class="callout-title markdown-alert-title">
    <svg class="callout-icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" fill="currentColor"><path d="M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"></path></svg>
    <code>custom_metadata_hook.py</code>
  </div><div class="callout-content"><div class="code-block-wrapper">
  <button class="copy-code-button" aria-label="Copy code to clipboard">
    <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
      <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
    </svg>
    <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
  </button><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hatchling.metadata.plugin.interface</span> <span class="kn">import</span> <span class="n">MetadataHookInterface</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CustomMetadataHook</span><span class="p">(</span><span class="n">MetadataHookInterface</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_current_python_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">major</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span>
</span></span><span class="line"><span class="cl">        <span class="n">minor</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">major</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">minor</span><span class="si">}</span><span class="s2">.0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_next_python_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">major</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span>
</span></span><span class="line"><span class="cl">        <span class="n">minor</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">major</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">minor</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Update the metadata.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">requires_python</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="sa">f</span><span class="s2">&#34;&gt;=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_python_version</span><span class="p">()</span><span class="si">}</span><span class="s2">,&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_python_version</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">metadata</span><span class="p">[</span><span class="s2">&#34;requires-python&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">requires_python</span></span></span></code></pre></div></div></div>
</blockquote><h3 id="create-a-build-hook">Create a build hook</h3>
<p>The metadata hook above only updates the wheel metadata, but not the filename of the wheel. By default, the filename of the wheel be something like <code>myproj-0.1.0-py3-none-any.whl</code> and so we need to customize this naming, so that we instead get <code>myproj-0.1.0-py39-none-any.whl</code>, <code>myproj-0.1.0-py310-none-any.whl</code>, <code>myproj-0.1.0-py311-none-any.whl</code> and so on, so that each wheel gets a unique filename.</p>
<p>Let&rsquo;s create <code>custom_build_hook.py</code>:</p>
<blockquote class="callout markdown-alert callout-note markdown-alert-note"><div class="callout-title markdown-alert-title">
    <svg class="callout-icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" fill="currentColor"><path d="M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"></path></svg>
    <code>custom_build_hook.py</code>
  </div><div class="callout-content"><div class="code-block-wrapper">
  <button class="copy-code-button" aria-label="Copy code to clipboard">
    <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
      <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
    </svg>
    <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
  </button><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hatchling.builders.hooks.plugin.interface</span> <span class="kn">import</span> <span class="n">BuildHookInterface</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CustomBuildHook</span><span class="p">(</span><span class="n">BuildHookInterface</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;A custom build hook for building .&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_python_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">major</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span>
</span></span><span class="line"><span class="cl">        <span class="n">minor</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;py</span><span class="si">{</span><span class="n">major</span><span class="si">}{</span><span class="n">minor</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">build_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Initialize the hook, update the build data.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;wheel&#34;</span><span class="p">,</span> <span class="s2">&#34;sdist&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">build_data</span><span class="p">[</span><span class="s2">&#34;tag&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_python_tag</span><span class="p">()</span><span class="si">}</span><span class="s2">-none-any&#34;</span></span></span></code></pre></div></div></div>
</blockquote><h3 id="edit-pyprojecttoml">Edit <code>pyproject.toml</code></h3>
<p>In order to build the wheel with these hooks, we&rsquo;ll need to tell hatchling about these new hooks, in <code>pyproject.toml</code>:</p>
<blockquote class="callout markdown-alert callout-note markdown-alert-note"><div class="callout-title markdown-alert-title">
    <svg class="callout-icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" fill="currentColor"><path d="M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"></path></svg>
    <code>pyproject.toml</code>
  </div><div class="callout-content"><div class="code-block-wrapper">
  <button class="copy-code-button" aria-label="Copy code to clipboard">
    <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
      <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
    </svg>
    <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
  </button><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">build-system</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">requires</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;hatchling&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">build-backend</span> <span class="p">=</span> <span class="s2">&#34;hatchling.build&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">project</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">name</span> <span class="p">=</span> <span class="s2">&#34;myproj&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">version</span> <span class="p">=</span> <span class="s2">&#34;0.1.0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">description</span> <span class="p">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nx">readme</span> <span class="p">=</span> <span class="s2">&#34;README.md&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">requires-python</span> <span class="p">=</span> <span class="s2">&#34;&gt;=3.9&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">license</span> <span class="p">=</span> <span class="s2">&#34;MIT&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">keywords</span> <span class="p">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="nx">authors</span> <span class="p">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="nx">classifiers</span> <span class="p">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="c"># https://pypi.org/classifiers/</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;License :: OSI Approved :: MIT License&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;Development Status :: 4 - Beta&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;Programming Language :: Python&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;Programming Language :: Python :: 3.9&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;Programming Language :: Python :: 3.10&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;Programming Language :: Python :: 3.11&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;Programming Language :: Python :: Implementation :: CPython&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;Programming Language :: Python :: Implementation :: PyPy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">dependencies</span> <span class="p">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">project</span><span class="p">.</span><span class="nx">optional-dependencies</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c"># PEP-440</span>
</span></span><span class="line"><span class="cl"><span class="nx">build</span> <span class="p">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;build&gt;=0.10.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">tool</span><span class="p">.</span><span class="nx">hatch</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="nx">targets</span><span class="p">.</span><span class="nx">sdist</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">tool</span><span class="p">.</span><span class="nx">hatch</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="nx">targets</span><span class="p">.</span><span class="nx">wheel</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">packages</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;myproj&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">only-include</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;myproj&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">tool</span><span class="p">.</span><span class="nx">hatch</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="nx">hooks</span><span class="p">.</span><span class="nx">custom</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">path</span> <span class="p">=</span> <span class="s2">&#34;tools/custom_build_hook.py&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">tool</span><span class="p">.</span><span class="nx">hatch</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">hooks</span><span class="p">.</span><span class="nx">custom</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">path</span> <span class="p">=</span> <span class="s2">&#34;tools/custom_metadata_hook.py&#34;</span></span></span></code></pre></div></div></div>
</blockquote><p>My project now looks something like this:</p>
<div class="code-block-wrapper">
  <button class="copy-code-button" aria-label="Copy code to clipboard">
    <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
      <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
    </svg>
    <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
  </button><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="err">â”œâ”€â”€</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">txt</span>
</span></span><span class="line"><span class="cl"><span class="err">â”œâ”€â”€</span> <span class="n">README</span><span class="o">.</span><span class="n">md</span>
</span></span><span class="line"><span class="cl"><span class="err">â”œâ”€â”€</span> <span class="n">pyproject</span><span class="o">.</span><span class="n">toml</span>
</span></span><span class="line"><span class="cl"><span class="err">â”œâ”€â”€</span> <span class="n">src</span>
</span></span><span class="line"><span class="cl"><span class="err">â”‚</span>Â Â  <span class="err">â””â”€â”€</span> <span class="n">myproj</span>
</span></span><span class="line"><span class="cl"><span class="err">â”‚</span>Â Â      <span class="err">â””â”€â”€</span> <span class="n">__init__</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl"><span class="err">â””â”€â”€</span> <span class="n">tools</span>
</span></span><span class="line"><span class="cl">    <span class="err">â”œâ”€â”€</span> <span class="n">custom_build_hook</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl">    <span class="err">â””â”€â”€</span> <span class="n">custom_metadata_hook</span><span class="o">.</span><span class="n">py</span></span></span></code></pre></div></div>
<h3 id="build-the-wheel">Build the wheel</h3>
<p>You should now be able to build the wheel and constrain it to the same Python version you used to build the wheel. I&rsquo;m using 




  
  
  
  
  
  

  
    
    
    
  

  
  
  
    
  

  
  

  <a href="https://github.com/pypa/build" target="_blank" rel="noopener" class="github-link"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>pypa/build</a> to build the wheel and therefore I need to first make sure I have that installed before building:</p>
<div class="code-block-wrapper">
  <button class="copy-code-button" aria-label="Copy code to clipboard">
    <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
      <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
    </svg>
    <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
  </button><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ pip install build
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ python -m build --wheel
</span></span><span class="line"><span class="cl">* Creating venv isolated environment...
</span></span><span class="line"><span class="cl">* Installing packages in isolated environment... <span class="o">(</span>hatchling<span class="o">)</span>
</span></span><span class="line"><span class="cl">* Getting build dependencies <span class="k">for</span> wheel...
</span></span><span class="line"><span class="cl">* Building wheel...
</span></span><span class="line"><span class="cl">Successfully built myproj-0.1.0-py310-none-any.whl</span></span></code></pre></div></div>
<blockquote class="callout markdown-alert callout-tip markdown-alert-tip"><div class="callout-title markdown-alert-title">
    <svg class="callout-icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></svg>
    Pro tip!
  </div><div class="callout-content"><p>You can add <code>print(metadata)</code> or <code>print(build_data)</code> in the <code>update</code> or <code>initialize</code> functions respectively and run <code>python -m build --wheel</code> to see a printout of all the data that you can modify here.</p></div>
</blockquote><p>If you try to pip-install this wheel using a different Python version, it should fail. This is using <code>pip</code> from Python 3.11 trying to install a wheel built with Python 3.10:</p>
<div class="code-block-wrapper">
  <button class="copy-code-button" aria-label="Copy code to clipboard">
    <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
      <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
    </svg>
    <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
  </button><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ pip install dist/myproj-0.1.0-py310-none-any.whl
</span></span><span class="line"><span class="cl">Processing ./dist/myproj-0.1.0-py310-none-any.whl
</span></span><span class="line"><span class="cl">INFO: pip is looking at multiple versions of myproj to determine which version is compatible with other requirements. This could take a <span class="k">while</span>.
</span></span><span class="line"><span class="cl">ERROR: Package <span class="s1">&#39;myproj&#39;</span> requires a different Python: 3.11.3 not in <span class="s1">&#39;&lt;3.11.0,&gt;=3.10.0&#39;</span></span></span></code></pre></div></div>
<h3 id="tying-it-all-together">Tying it all together</h3>
<p>You can setup your CI so that it uses a matrix of Python versions. For each Python version you generate the wheel contents, build a wheel and store the wheel as CI build artifact. As a final step you can have a CI step that fetches all the built CI wheel artifacts and uploads them to PyPi. Great success! ðŸŽ¯</p>
<p>You can read more about hatchling&rsquo;s metadata hook and build hook 



<a href="https://hatch.pypa.io/latest/plugins/metadata-hook/custom/" target="_blank" rel="noopener">here</a> and 



<a href="https://hatch.pypa.io/latest/plugins/build-hook/custom/" target="_blank" rel="noopener">here</a>.</p>

</main>


<div id="giscus-container" class="giscus-comments">
  <div class="load-comments-wrapper">
    <button id="load-comments-btn" class="load-comments-btn">Load Comments</button>
  </div>
</div>

<script>
  (function() {
    const container = document.getElementById('giscus-container');
    const loadBtn = document.getElementById('load-comments-btn');

    
    function loadGiscus() {
      if (!container) return;
      
      
      container.innerHTML = ''; 

      const theme = document.body.classList.contains('dark') ? 'dark' : 'light';
      
      const giscusScript = document.createElement('script');
      giscusScript.src = 'https://giscus.app/client.js';
      giscusScript.setAttribute('data-repo', 'fredrikaverpil/fredrikaverpil.github.io');
      giscusScript.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnkxMzEwNDU4Njc=');
      giscusScript.setAttribute('data-category', 'General');
      giscusScript.setAttribute('data-category-id', 'DIC_kwDOB8-Z684CU9zc');
      giscusScript.setAttribute('data-mapping', 'title');
      giscusScript.setAttribute('data-strict', '0');
      giscusScript.setAttribute('data-reactions-enabled', '1');
      giscusScript.setAttribute('data-emit-metadata', '0');
      giscusScript.setAttribute('data-input-position', 'bottom');
      giscusScript.setAttribute('data-theme', theme);
      giscusScript.setAttribute('data-lang', 'en');
      giscusScript.setAttribute('crossorigin', 'anonymous');
      giscusScript.async = true;

      container.appendChild(giscusScript);
    }

    
    if (loadBtn) {
      loadBtn.addEventListener('click', loadGiscus);
    }

    
    function setGiscusTheme(theme) {
      const giscusFrame = document.querySelector('iframe.giscus-frame');
      if (giscusFrame && giscusFrame.contentWindow) {
        giscusFrame.contentWindow.postMessage(
          { giscus: { setConfig: { theme } } },
          'https://giscus.app'
        );
      }
    }

    
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        
        setTimeout(() => {
          const currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
          setGiscusTheme(currentTheme);
        }, 10); 
      });
    }

    
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
        if (!localStorage.getItem('theme')) { 
          const newTheme = event.matches ? "dark" : "light";
          setGiscusTheme(newTheme);
        }
      });
    }
  })();
</script>



<footer>
	<div class="footer-content">
		<span class="footer-icons">
			
			
			<a href="https://github.com/fredrikaverpil" target="_blank" rel="noopener" title="GitHub">
				

<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>

			</a>
			
			
			<a href="https://fosstodon.org/@fredrikaverpil" target="_blank" rel="noopener" title="Mastodon">
				

<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" fill="currentColor"><path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792 0 11.813 0h-.03c-3.98 0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057 0 0 0 .023-.043v-1.809a.052.052 0 0 0-.02-.041.053.053 0 0 0-.046-.01 20.282 20.282 0 0 1-4.709.545c-2.73 0-3.463-1.284-3.674-1.818a5.593 5.593 0 0 1-.319-1.433.053.053 0 0 1 .066-.054c1.517.363 3.072.546 4.632.546.376 0 .75 0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23 0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112 0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311 0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13 0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"/></svg>

			</a>
			
			
			<a href="https://bsky.app/profile/fredrikaverpil.bsky.social" target="_blank" rel="noopener" title="Bluesky">
				

<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" fill="currentColor"><path d="M5.202 2.857C7.954 4.922 10.913 9.11 12 11.358c1.087-2.247 4.046-6.436 6.798-8.501C20.783 1.366 24 .213 24 3.883c0 .732-.42 6.156-.667 7.037-.856 3.061-3.978 3.842-6.755 3.37 4.854.826 6.089 3.562 3.422 6.299-5.065 5.196-7.28-1.304-7.847-2.97-.104-.305-.152-.448-.153-.327 0-.121-.05.022-.153.327-.568 1.666-2.782 8.166-7.847 2.97-2.667-2.737-1.432-5.473 3.422-6.3-2.777.473-5.899-.308-6.755-3.369C.42 10.04 0 4.615 0 3.883c0-3.67 3.217-2.517 5.202-1.026"/></svg>

			</a>
			
			
			<a href="https://linkedin.com/in/fredrik" target="_blank" rel="noopener" title="LinkedIn">
				

<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>

			</a>
			
			
			<a href="/blog/index.xml" target="_blank" rel="noopener" title="RSS">
				

<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" fill="currentColor"><path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/></svg>

			</a>
			
			
			<a href="https://cloud.umami.is/share/tJcIgDO3dznRmeGX" target="_blank" rel="noopener" title="Umami">
				

<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" fill="currentColor"><path d="M2.203 8.611H.857a.845.845 0 0 0-.841.841v.858a13.31 13.31 0 0 0-.016.6c0 6.627 5.373 12 12 12 6.527 0 11.837-5.212 11.996-11.701 0-.025.004-.05.004-.075V9.452a.845.845 0 0 0-.841-.841h-1.346c-1.159-4.329-5.112-7.521-9.805-7.521-4.692 0-8.645 3.192-9.805 7.521Zm18.444 0H3.37c1.127-3.702 4.57-6.399 8.638-6.399 4.069 0 7.512 2.697 8.639 6.399Z"/></svg>

			</a>
			
		</span>
		<span class="footer-text">
			Â© Mark Holloway 2005-2026
		</span>
	</div>
	<script src="/js/main.js"></script>

</footer>
</body>

</html>

